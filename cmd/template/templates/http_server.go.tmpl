// Code generated by {{.GeneratorInfo.Name }}. DO NOT EDIT.
// {{ .GeneratorInfo.Name }} {{ .GeneratorInfo.Version }}

package {{ .PackageName }}

import (
	"context"
	"net/http"

	"github.com/go-chi/chi/v5"
	"github.com/jasonhancock/go-api"
	"github.com/justinas/alice"
)

// Responder is responsible for sending requests to the client.
type Responder interface {
	With(w http.ResponseWriter, req *http.Request, status int, data any)
	Err(w http.ResponseWriter, req *http.Request, err error)
}

// SVC is the interface required of the service.
type SVC interface {
{{- range .Handlers }}
	{{ .ExportedName }}({{ .TypeList }}) {{ if .ResponseType }}({{ .ResponseType }}, {{end}}error{{ if .ResponseType}}){{end}}
{{- end }}
	SVCCustomizations
}

{{ range .Security }}
type {{ typename .Name }} interface {
	Authorized({{.AuthzArgs}}) func(next http.Handler) http.Handler
}
{{- end }}

// HTTPServer is the transport layer for the service.
type HTTPServer struct {
	svc     SVC
	router  chi.Router
	respond Responder
}

// NewHTTPServer constructs a new HTTPServer.
func NewHTTPServer(svc SVC, r Responder, rt chi.Router{{ if .Security }}, {{ .SecurityArgs }}{{ end }}) *HTTPServer {
	s := &HTTPServer{
		svc:     svc,
		respond: r,
		router:  rt,
	}
{{ range $_, $v := .Security }}
{{ range $permIdx, $perm := .ArgPermutations -}}
	{{ argname $v.Name }}AuthzPerm{{ $permIdx }} := alice.New()
{{ end -}}
	if {{ argname $v.Name }} != nil {
{{ range $permIdx, $perm := .ArgPermutations -}}
		{{ argname $v.Name}}AuthzPerm{{ $permIdx }} = {{ argname $v.Name}}AuthzPerm{{ $permIdx }}.Append({{ argname $v.Name }}.Authorized({{ $perm.ArgStr }}))
{{ end -}}
	}
{{ end }}

{{ range .Routes }}
	{{ .GetRoute }}
{{- end }}

	return s
}

// ServeHTTP fulfills the http.Handler interface.
func (s *HTTPServer) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	s.router.ServeHTTP(w, r)
}

{{ range .Handlers }}
func (s *HTTPServer) {{ .Name }}(w http.ResponseWriter, r *http.Request) {
{{- if .RequestBodyType -}}
        var req {{ .RequestBodyType }}
        if err := api.Decode(r, &req); err != nil {
                s.respond.Err(w, r, err)
                return
        }
{{ end -}}
{{- range .Params }}
{{- if eq .Location "path" }}
{{- .PathAssignment }}
{{- end }}
{{ end -}}
{{- if .Params.HasQuery -}}
	qp, err := get{{ typename .Name }}Parms(r.URL.Query())
	if err != nil {
		s.respond.Err(w, r, err)
		return
	}

{{- end }}
	{{ if .ResponseType}}resp, {{ end }}err := s.svc.{{ .ExportedName }}({{ .ValueList true }})
	if err != nil {
		s.respond.Err(w, r, err)
		return
	}

	s.respond.With(w, r, {{ .SuccessStatusCode }}, {{ if .ResponseType }}resp{{ else }}nil{{ end}})
}
{{end}}
